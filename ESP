local player = game:GetService("Players").LocalPlayer
local replicatedStorage = game:GetService("ReplicatedStorage")
local tweenService = game:GetService("TweenService")

-- Create a persistent highlight
local highlight = Instance.new("Highlight")
highlight.Parent = player -- Parent it to the player so it can persist
highlight.FillColor = Color3.fromRGB(255, 255, 255) -- Default fill color
highlight.OutlineColor = Color3.fromRGB(0, 0, 0) -- Default outline color

-- Create the player info label
local playerInfoLabel = Instance.new("TextLabel") -- Create a TextLabel
playerInfoLabel.Size = UDim2.new(1, 0, 1, 0) -- Fill its parent
playerInfoLabel.BackgroundTransparency = 1 -- Make background transparent
playerInfoLabel.TextColor3 = Color3.new(1, 1, 1) -- Initial text color (white)
playerInfoLabel.TextScaled = false -- Disable scaling to set a fixed size
playerInfoLabel.TextSize = 20 -- Set the desired text size (adjust as needed)
playerInfoLabel.TextWrapped = false -- Ensure the text stays on one line
playerInfoLabel.Parent = highlight -- Set the player info label as a child of the highlight

-- Function to create or update the GUI
local function createGUI(character)
    -- Wait for the character's Head to be available
    local head = character:WaitForChild("Head")

    -- Create a BillboardGui for the display name and stats
    local billboardGui = head:FindFirstChild("BillboardGui") or Instance.new("BillboardGui")
    billboardGui.Parent = head
    billboardGui.Size = UDim2.new(0, 200, 0, 50) -- Size of the GUI
    billboardGui.StudsOffset = Vector3.new(0, 2, 0) -- Position above the head
    billboardGui.Adornee = head -- Set the object it will be attached to
    billboardGui.AlwaysOnTop = true -- Keep it always on top

    -- Create or reuse the TextLabel
    local usernameLabel = billboardGui:FindFirstChild("UsernameLabel") or Instance.new("TextLabel")
    usernameLabel.Name = "UsernameLabel" -- Set name for easy reference
    usernameLabel.Parent = billboardGui
    usernameLabel.Size = UDim2.new(1, 0, 1, 0) -- Fill the BillboardGui
    usernameLabel.BackgroundTransparency = 1 -- Make background transparent
    usernameLabel.TextColor3 = Color3.new(1, 1, 1) -- Initial text color (white)
    usernameLabel.TextScaled = false -- Disable scaling to set a fixed size
    usernameLabel.TextSize = 20 -- Set the desired text size (adjust as needed)
    usernameLabel.TextWrapped = false -- Ensure the text stays on one line

    -- Fetch player stats from ReplicatedStorage
    local playerStats = replicatedStorage:FindFirstChild("Datas"):FindFirstChild(tostring(player.UserId))
    local ownerTag = ""
    local totalStats = math.huge -- Start with the highest possible value
    local rebirths = 0 -- Default rebirths

    if playerStats then
        -- Fetch rebirth data
        local playerRebirths = playerStats:FindFirstChild("Rebirth") and playerStats.Rebirth.Value or 0

        -- Fetch the various stats
        local strengthStat = playerStats:FindFirstChild("Strength") and playerStats.Strength.Value or math.huge
        local defenceStat = playerStats:FindFirstChild("Defense") and playerStats.Defense.Value or math.huge
        local energyStat = playerStats:FindFirstChild("Energy") and playerStats.Energy.Value or math.huge
        local speedStat = playerStats:FindFirstChild("Speed") and playerStats.Speed.Value or math.huge

        -- Calculate the lowest stat
        totalStats = math.min(strengthStat, defenceStat, energyStat, speedStat)

        -- Add "Owner" tag if the player is one of the specified usernames
        if player.Name == "Steve72009" or player.Name == "Pserson2" or player.Name == "whowhatwhen1230" or player.Name == "Reekennedy1057" then
            ownerTag = " || Script Dev"
            usernameLabel.Font = Enum.Font.SpecialElite -- Change font to Special Elite
        else
            usernameLabel.Font = Enum.Font.Cartoon -- Default font for other players
        end

        -- Format the display name, total stats, rebirths, and health
        usernameLabel.Text = string.format("%s || %s, %d%s", 
            player.DisplayName, 
            format_number(totalStats), 
            playerRebirths, 
            ownerTag)
    else
        usernameLabel.Text = player.DisplayName -- Fallback if stats not found
    end

    usernameLabel.TextStrokeTransparency = .01

    -- Update highlight and text colors based on the total stats
    updateHighlight(totalStats)
end

-- Color ranges for stats
local colorRanges = {
    {max = 1e6, color = Color3.fromRGB(105, 105, 105)}, -- Dark Gray for <1M
    {max = 5e6, color = Color3.fromRGB(0, 100, 0)},     -- Dark Green for 1M - 5M
    {max = 30e6, color = Color3.fromRGB(144, 238, 144)},-- Light Green for 5M - 30M
    {max = 120e6, color = Color3.fromRGB(0, 0, 128)},   -- Navy Blue for 30M - 120M
    {max = 1e9, color = Color3.fromRGB(0, 0, 255)},     -- Blue for 120M - 1B
    {max = 5e9, color = Color3.fromRGB(173, 216, 230)}, -- Light Blue for 1B - 5B
    {max = 30e9, color = Color3.fromRGB(0, 255, 255)},  -- Cyan for 5B - 30B
    {max = 1e11, color = Color3.fromRGB(255, 215, 0)},  -- Gold for 30B - 100B
    {max = 1e12, color = Color3.fromRGB(255, 255, 0)},  -- Yellow for 100B - 1T
    {max = 1e13, color = Color3.fromRGB(220, 20, 60)},  -- Crimson for 1T - 10T
    {max = 1e14, color = Color3.fromRGB(255, 0, 0)},    -- Red for 10T - 100T
}

local outlineColorRanges = {
    {max = 1e6, color = Color3.fromRGB(0, 0, 0)},       -- Black for <1M
    {max = 5e6, color = Color3.fromRGB(105, 105, 105)},  -- Dark Gray for 1M - 5M
    {max = 1e8, color = Color3.fromRGB(124, 252, 0)},    -- Grass Green for 5M - 100M
    {max = 1e10, color = Color3.fromRGB(255, 165, 0)},   -- Orange for 100M - 10B
    {max = 1e11, color = Color3.fromRGB(255, 255, 0)},   -- Yellow for 10B - 100B
    {max = 1e12, color = Color3.fromRGB(255, 215, 0)},   -- Gold for 100B - 1T
    {max = 5e13, color = Color3.fromRGB(255, 0, 0)},     -- Red for 1T - 50T
    {max = 5e14, color = Color3.fromRGB(139, 0, 0)},     -- Blood Red for 50T - 500T
    {max = math.huge, color = Color3.fromRGB(255, 255, 255)}, -- White for 500T+
}

local tweenInfo = TweenInfo.new(1, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, -1, true) -- Looping tween info

local function smoothColorCycle()
    local cycleColors = {
        Color3.fromRGB(105, 105, 105),   -- Dark Gray
        Color3.fromRGB(0, 100, 0),       -- Dark Green
        Color3.fromRGB(144, 238, 144),   -- Light Green
        Color3.fromRGB(0, 0, 128),       -- Navy Blue
        Color3.fromRGB(0, 0, 255),       -- Blue
        Color3.fromRGB(173, 216, 230),   -- Light Blue
        Color3.fromRGB(0, 255, 255),     -- Cyan
        Color3.fromRGB(255, 215, 0),     -- Gold
        Color3.fromRGB(255, 255, 0),     -- Yellow
        Color3.fromRGB(220, 20, 60),     -- Crimson
        Color3.fromRGB(255, 0, 0)        -- Red
    }

    for _, color in ipairs(cycleColors) do
        local tween = tweenService:Create(highlight, tweenInfo, {FillColor = color})
        tween:Play()
        tween.Completed:Wait()
    end
end

-- Update highlight color based on total stats
local function updateHighlight(totalStats)
    for _, range in ipairs(colorRanges) do
        if totalStats < range.max then
            highlight.FillColor = range.color -- Set fill color
            break
        end
    end

    for _, outlineRange in ipairs(outlineColorRanges) do
        if totalStats < outlineRange.max then
            highlight.OutlineColor = outlineRange.color -- Set outline color
            break
        end
    end

    if totalStats >= 100000000000 then
        smoothColorCycle() -- Start color cycling if the total stats are 100T+
    else
        -- Stop the cycling if not at 100T+
        highlight.FillColor = highlight.FillColor -- Keep current color
    end
end

-- Connect to character added event
player.CharacterAdded:Connect(createGUI)

-- If the player's character already exists, call createGUI
if player.Character then
    createGUI(player.Character)
end

-- Run the function to create GUI initially
createGUI(player.Character or player.CharacterAdded:Wait())
